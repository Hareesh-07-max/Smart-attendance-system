<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard - Attendance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gradient-to-br from-green-50 to-teal-100 min-h-screen p-6">

<div class="bg-white p-6 rounded-2xl shadow-md max-w-3xl mx-auto">
  <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">üë©‚Äçüè´ Teacher Dashboard</h1>

  <!-- Search bar -->
  <div class="flex gap-2 mb-4">
    <input id="searchInput" type="text" placeholder="üîç Search by ID"
           class="flex-1 px-4 py-2 border rounded-lg">
    <button onclick="fetchAllAttendance()"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
      üìä Show Summary
    </button>
  </div>

  <div id="result" class="mt-4 overflow-x-auto"></div>

  <!-- Back to Home button -->
  <div class="mt-4 text-center">
    <a href="index.html" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">‚¨ÖÔ∏è Back to Home</a>
  </div>
</div>

<script>
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdMHIJ5IUW60rjdruE-lh96vAEcaJxbL55h-P2AKnbLwu45xgRMmU-fEoO3lwS8ypeIzZjpGmzHbvF/pub?output=csv";
const startDate = new Date("2025-09-15");
const endDate = new Date("2025-09-28");

let globalStudents = {};
let globalClassDates = [];

// Generate class dates excluding Sundays and only up to today
function generateClassDates(start, end) {
  let dates = [];
  const todayStr = new Date().toISOString().split("T")[0];
  for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    const dStr = d.toISOString().split("T")[0];
    if (d.getDay() !== 0 && dStr <= todayStr) {
      dates.push(dStr);
    }
  }
  return dates;
}

function fetchAllAttendance() {
  Papa.parse(sheetUrl, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      const data = results.data.map(row => {
        let obj = {};
        for (let key in row) {
          obj[key.trim()] = row[key]?.trim();
        }
        return obj;
      });

      globalClassDates = generateClassDates(startDate, endDate);
      globalStudents = {};

      data.forEach(row => {
        const id = row["ID number"];
        const timestamp = row["Timestamp"];
        if(id && timestamp) {
          let datePart = timestamp.split(" ")[0].trim();
          let [day, month, year] = datePart.split("/");
          if(day && month && year) {
            const formattedDate = `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
            if(!globalStudents[id]) globalStudents[id] = { dates: new Set() };
            globalStudents[id].dates.add(formattedDate);
          }
        }
      });

      renderTable();
    }
  });
}

function renderTable() {
  const searchQuery = document.getElementById("searchInput").value.trim().toLowerCase();
  const classDates = globalClassDates;

  let table = `<table class="w-full border border-gray-300 text-sm">
    <tr class="bg-gray-200">
      <th class="border px-2 py-1">ID</th>
      <th class="border px-2 py-1">Present</th>
      <th class="border px-2 py-1">Absent</th>
      <th class="border px-2 py-1">Percentage</th>
    </tr>`;

  for (let id in globalStudents) {
    if(searchQuery && !id.toLowerCase().includes(searchQuery)) continue;

    const student = globalStudents[id];
    let presentDays = 0;
    classDates.forEach(date => {
      if(student.dates.has(date)) presentDays++;
    });

    const totalDays = classDates.length;
    const absentDays = totalDays - presentDays;
    const percentage = totalDays > 0 ? ((presentDays/totalDays)*100).toFixed(2) : 0;
    const percentColor = percentage < 75 ? "text-red-600" : "text-green-600";

    table += `<tr>
      <td class="border px-2 py-1">${id}</td>
      <td class="border px-2 py-1 text-green-600 font-bold">${presentDays}</td>
      <td class="border px-2 py-1 text-red-600 font-bold">${absentDays}</td>
      <td class="border px-2 py-1 ${percentColor} font-bold">${percentage}%</td>
    </tr>`;
  }

  table += `</table>
    <p class="mt-3 font-bold">Total Classes (till today, excluding Sundays): ${classDates.length}</p>`;

  document.getElementById("result").innerHTML = table;
}

// Enable live search
document.getElementById("searchInput").addEventListener("input", renderTable);
</script>

</body>
</html>
