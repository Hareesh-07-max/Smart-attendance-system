<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex flex-col items-center p-6">

  <div class="bg-white p-6 rounded-xl shadow-md w-full max-w-6xl">
    <h1 id="welcomeMsg" class="text-2xl font-bold text-gray-800 mb-6 text-center">ğŸ‘©â€ğŸ« Welcome Teacher</h1>

    <!-- Google Sheet Embed -->
    <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ“Š Attendance Records (Google Sheet)</h2>
    <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRdMHIJ5IUW60rjdruE-lh96vAEcaJxbL55h-P2AKnbLwu45xgRMmU-fEoO3lwS8ypeIzZjpGmzHbvF/pubhtml?widget=true&amp;headers=false"
      width="100%" height="400px" class="mb-6"></iframe>

    <!-- Search Bar -->
    <div class="mb-4 flex justify-end">
      <input type="text" id="searchBox" placeholder="ğŸ” Search by ID or Name..." 
        class="border border-gray-300 px-4 py-2 rounded-lg w-64 focus:outline-none focus:ring-2 focus:ring-indigo-400">
    </div>

    <!-- Attendance Table -->
    <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ“‹ Student Attendance Summary</h2>
    <div class="overflow-x-auto">
      <table class="w-full border border-gray-300 text-center" id="attendanceTableWrapper">
        <thead class="bg-indigo-200">
          <tr>
            <th class="border px-4 py-2">ID Number</th>
            <th class="border px-4 py-2">Name</th>
            <th class="border px-4 py-2">Total Classes</th>
            <th class="border px-4 py-2">Present</th>
            <th class="border px-4 py-2">Attendance %</th>
          </tr>
        </thead>
        <tbody id="attendanceTable" class="bg-white"></tbody>
      </table>
    </div>

    <!-- Buttons -->
    <div class="mt-6 flex justify-between">
      <a href="teacher_login.html" onclick="localStorage.removeItem('loggedInTeacher')" 
         class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
        â¬…ï¸ Logout
      </a>
      <a href="index.html" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
        ğŸ  Back to Home
      </a>
    </div>
  </div>

  <script>
    // Check login
    const teacher = localStorage.getItem("loggedInTeacher");
    if (teacher) {
      document.getElementById("welcomeMsg").textContent = `ğŸ‘©â€ğŸ« Welcome, ${teacher}!`;
    } else {
      window.location.href = "teacher_login.html";
    }

    // Load student data
    let allRows = [];

    async function loadAttendance() {
      try {
        const response = await fetch("students.csv");
        const data = await response.text();
        const rows = data.trim().split("\n").map(r => r.split(","));

        const header = rows[0]; 
        const idIndex = header.indexOf("ID Number");
        const nameIndex = header.indexOf("Name");

        const attendanceData = {};
        rows.slice(1).forEach(row => {
          const id = row[idIndex];
          const name = row[nameIndex];
          if (!attendanceData[id]) {
            attendanceData[id] = { name, total: 0, present: 0 };
          }
          attendanceData[id].total++;
          if (row.includes("Present")) {
            attendanceData[id].present++;
          }
        });

        allRows = Object.keys(attendanceData).map(id => {
          const s = attendanceData[id];
          const percent = ((s.present / s.total) * 100).toFixed(2);
          return {
            id, 
            name: s.name, 
            total: s.total, 
            present: s.present, 
            percent
          };
        });

        renderTable(allRows);

      } catch (err) {
        console.error("Error loading attendance:", err);
      }
    }

    function renderTable(rows) {
      const table = document.getElementById("attendanceTable");
      table.innerHTML = "";
      rows.forEach(s => {
        table.innerHTML += `
          <tr>
            <td class="border px-4 py-2">${s.id}</td>
            <td class="border px-4 py-2">${s.name}</td>
            <td class="border px-4 py-2">${s.total}</td>
            <td class="border px-4 py-2">${s.present}</td>
            <td class="border px-4 py-2">${s.percent}%</td>
          </tr>`;
      });
    }

    // Search function
    document.getElementById("searchBox").addEventListener("input", function() {
      const query = this.value.toLowerCase();
      const filtered = allRows.filter(s => 
        s.id.toLowerCase().includes(query) || s.name.toLowerCase().includes(query)
      );
      renderTable(filtered);
    });

    loadAttendance();
  </script>

</body>
</html>
