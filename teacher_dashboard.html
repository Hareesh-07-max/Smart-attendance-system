<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard - Smart Attendance System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">

  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">ðŸ“Š Teacher Dashboard</h1>
    <button onclick="logout()" 
      class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
      ðŸšª Logout
    </button>
  </div>

  <!-- Attendance Table -->
  <div class="bg-white p-6 rounded-2xl shadow-md overflow-x-auto">
    <table class="w-full border border-gray-300 text-sm" id="attendanceTable">
      <thead class="bg-gray-200">
        <tr>
          <th class="border px-2 py-1">Student ID</th>
          <th class="border px-2 py-1">Present</th>
          <th class="border px-2 py-1">Absent</th>
          <th class="border px-2 py-1">Percentage</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdMHIJ5IUW60rjdruE-lh96vAEcaJxbL55h-P2AKnbLwu45xgRMmU-fEoO3lwS8ypeIzZjpGmzHbvF/pub?output=csv";

    const startDate = new Date("2025-09-15");
    const today = new Date();

    // Generate class dates excluding Sundays
    function generateClassDates(start, end) {
      let dates = [];
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        if(d.getDay() !== 0) { 
          dates.push(d.toISOString().split("T")[0]);
        }
      }
      return dates;
    }

    function loadAttendance() {
      Papa.parse(sheetUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const data = results.data;

          const normalizedData = data.map(row => {
            let obj = {};
            for (let key in row) {
              obj[key.trim()] = row[key]?.trim();
            }
            return obj;
          });

          let studentMap = {};

          normalizedData.forEach(row => {
            const id = row["ID number"];
            const timestamp = row["Timestamp"];
            if(id && timestamp) {
              let datePart = timestamp.split(" ")[0].trim();
              let [day, month, year] = datePart.split("/");
              if(day && month && year) {
                const formattedDate = `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
                if(!studentMap[id]) studentMap[id] = new Set();
                studentMap[id].add(formattedDate);
              }
            }
          });

          const classDates = generateClassDates(startDate, today);

          const tbody = document.getElementById("tableBody");
          tbody.innerHTML = "";

          for (let id in studentMap) {
            let presentDays = 0;
            classDates.forEach(date => {
              if(studentMap[id].has(date)) presentDays++;
            });

            const totalDays = classDates.length;
            const absentDays = totalDays - presentDays;
            const percentage = totalDays > 0 ? ((presentDays / totalDays) * 100).toFixed(2) : 0;

            const percentColor = percentage < 75 ? "text-red-600" : "text-green-600";

            let row = `<tr>
              <td class="border px-2 py-1 font-medium">${id}</td>
              <td class="border px-2 py-1 text-green-600 font-bold">${presentDays}</td>
              <td class="border px-2 py-1 text-red-600 font-bold">${absentDays}</td>
              <td class="border px-2 py-1 ${percentColor} font-bold">${percentage}%</td>
            </tr>`;
            tbody.innerHTML += row;
          }
        }
      });
    }

    function logout() {
      window.location.href = "index.html";
    }

    loadAttendance();
  </script>

</body>
</html>
