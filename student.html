<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Attendance Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl">
    <h1 class="text-2xl font-bold mb-4 text-center">ðŸŽ“ Student Attendance Portal</h1>

    <!-- Search box -->
    <div class="flex space-x-2 mb-6 justify-center">
      <input id="studentId" type="text" placeholder="Enter your ID Number"
             class="px-4 py-2 border rounded-lg w-64">
      <button onclick="fetchAttendance()"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Search</button>
    </div>

    <!-- Results -->
    <div id="result"></div>
  </div>

  <script>
    const sheetUrl = "attendance.csv"; // CSV in repo root
    const startDate = new Date("2025-09-08");
    const endDate = new Date("2025-09-28");

    function generateClassDates(start, end) {
      let dates = [];
      let today = new Date();
      let cutoff = today < end ? today : end;

      for (let d = new Date(start); d <= cutoff; d.setDate(d.getDate() + 1)) {
        if (d.getDay() !== 0) dates.push(d.toISOString().split("T")[0]);
      }
      return dates;
    }

    async function fetchAttendance() {
      const studentIdInput = document.getElementById("studentId").value.trim();
      if (!studentIdInput) return alert("Enter a valid ID number!");

      try {
        const res = await fetch(sheetUrl);
        if (!res.ok) throw new Error("Could not load CSV. Check file path.");
        const data = await res.text();

        const rows = data.split(/\r?\n/).map(r => r.split(","));
        const headers = rows[0].map(h => h.replace(/"/g,'').trim());
        const dateIndex = headers.indexOf("Timestamp");
        const idIndex = headers.indexOf("ID number");

        let studentDates = new Set();

        rows.slice(1).forEach(row => {
          if (!row || row.length <= Math.max(dateIndex, idIndex)) return;
          let id = row[idIndex]?.replace(/"/g,'').trim();
          let csvTimestamp = row[dateIndex]?.replace(/"/g,'').trim();

          if (id && csvTimestamp) {
            // Extract only date, ignore time
            let dateOnly = csvTimestamp.split(" ")[0]; // "08/09/2025 06:30:00" â†’ "08/09/2025"
            const parts = dateOnly.split("/");
            if (parts.length === 3) {
              const formattedDate = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
              studentDates.add(`${id}|${formattedDate}`);
            }
          }
        });

        const classDates = generateClassDates(startDate, endDate);
        let presentDays = 0;
        const todayStr = new Date().toISOString().split("T")[0];

        let table = `
          <p class="mb-2 font-semibold">Attendance for <span class="text-blue-600">${studentIdInput}</span></p>
          <table class="w-full border border-gray-300 text-sm">
            <tr class="bg-gray-200">
              <th class="border px-2 py-1">Date</th>
              <th class="border px-2 py-1">Status</th>
            </tr>
        `;

        classDates.forEach(date => {
          const status = studentDates.has(`${studentIdInput}|${date}`) ? "Present" : "Absent";
          if (status === "Present") presentDays++;
          const rowClass = date === todayStr ? "bg-yellow-100" : "";
          table += `
            <tr class="${rowClass}">
              <td class="border px-2 py-1">${date}</td>
              <td class="border px-2 py-1 ${status === "Present" ? "text-green-600 font-bold" : "text-red-600 font-bold"}">${status}</td>
            </tr>
          `;
        });

        const totalDays = classDates.length;
        const percentage = totalDays > 0 ? ((presentDays / totalDays) * 100).toFixed(2) : 0;
        const percentColor = percentage < 75 ? "text-red-600" : "text-green-600";

        table += `</table>
          <p class="mt-3 font-bold">Total Classes (till today): ${totalDays}, Present: ${presentDays}, Absent: ${totalDays - presentDays}</p>
          <p class="font-bold ${percentColor}">Attendance Percentage: ${percentage}%</p>
        `;

        document.getElementById("result").innerHTML = table;

      } catch (err) {
        alert("Error loading CSV: " + err.message);
      }
    }
  </script>
</body>
</html>
