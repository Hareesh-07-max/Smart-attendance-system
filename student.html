<script>
  const sheetUrl = "https://hareesh-07-max.github.io/Smart-attendance-system/attendance.csv";

  const startDate = new Date("2025-09-08");
  const endDate = new Date("2025-09-28");

  function generateClassDates(start, end) {
    let dates = [];
    let today = new Date();
    let cutoff = today < end ? today : end;
    for (let d = new Date(start); d <= cutoff; d.setDate(d.getDate() + 1)) {
      if (d.getDay() !== 0) {
        dates.push(d.toISOString().split("T")[0]);
      }
    }
    return dates;
  }

  async function fetchAttendance() {
    const studentId = document.getElementById("studentId").value.trim();
    if (!studentId) return alert("Enter a valid ID number!");

    const res = await fetch(sheetUrl);
    const data = await res.text();

    const rows = data.split("\n").map(r => r.split(","));
    const headers = rows[0];
    const dateIndex = headers.indexOf("Timestamp");
    const idIndex = headers.indexOf("ID number");

    let studentDates = new Set();
    let debugOutput = "<h3 class='font-bold mb-2'>üîç Debug Info:</h3>";

    rows.slice(1).forEach(row => {
      if (!row || row.length <= Math.max(dateIndex, idIndex)) return;
      let id = row[idIndex]?.replace(/"/g,'').trim();
      let csvTimestamp = row[dateIndex]?.replace(/"/g,'').trim();

      debugOutput += `<p>ID from CSV: <b>${id}</b> | Timestamp: <b>${csvTimestamp}</b></p>`;

      if (id && csvTimestamp) {
        let dateOnly = csvTimestamp.split(" ")[0];
        const parts = dateOnly.split("/");
        if (parts.length === 3) {
          const formattedDate = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
          debugOutput += `<p>Formatted Date: <b>${formattedDate}</b></p>`;
          studentDates.add(`${id}|${formattedDate}`);
        }
      }
    });

    // Display debug info above results
    document.getElementById("result").innerHTML = debugOutput + "<hr class='my-3'>";

    // Now proceed with normal attendance calculation...
    const classDates = generateClassDates(startDate, endDate);
    let presentDays = 0;
    let table = `
      <p class="mb-2 font-semibold">Attendance for <span class="text-blue-600">${studentId}</span></p>
      <table class="w-full border border-gray-300 text-sm">
        <tr class="bg-gray-200">
          <th class="border px-2 py-1">Date</th>
          <th class="border px-2 py-1">Status</th>
        </tr>
    `;

    classDates.forEach(date => {
      let status = studentDates.has(`${studentId}|${date}`) ? "Present" : "Absent";
      if (status === "Present") presentDays++;
      table += `
        <tr>
          <td class="border px-2 py-1">${date}</td>
          <td class="border px-2 py-1 ${status === "Present" ? "text-green-600 font-bold" : "text-red-600 font-bold"}">${status}</td>
        </tr>
      `;
    });

    let totalDays = classDates.length;
    let percentage = totalDays > 0 ? ((presentDays / totalDays) * 100).toFixed(2) : 0;
    let percentColor = percentage < 75 ? "text-red-600" : "text-green-600";

    table += `</table>
      <p class="mt-3 font-bold">Total Classes (till today): ${totalDays}, Present: ${presentDays}, Absent: ${totalDays - presentDays}</p>
      <p class="font-bold ${percentColor}">Attendance Percentage: ${percentage}%</p>
    `;

    document.getElementById("result").innerHTML += table;
  }
</script>
