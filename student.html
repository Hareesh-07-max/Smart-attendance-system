<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Attendance Portal</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h2 { text-align: center; }
    .container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #007BFF; color: white; }
    .present { background: #c8e6c9; }
    .absent { background: #ffcdd2; }
    .low { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Student Attendance Portal</h2>
    <label for="studentId">Enter Student ID:</label>
    <input type="text" id="studentId" placeholder="e.g. R230557">
    <button onclick="loadAttendance()">Search</button>
    <div id="result"></div>
  </div>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdMHIJ5IUW60rjdruE-lh96vAEcaJxbL55h-P2AKnbLwu45xgRMmU-fEoO3lwS8ypeIzZjpGmzHbvF/pub?output=csv";

    async function loadAttendance() {
      const studentId = document.getElementById("studentId").value.trim();
      if (!studentId) {
        alert("Please enter a Student ID");
        return;
      }

      const response = await fetch(sheetUrl);
      const data = await response.text();

      const rows = data.split("\n").map(r => r.split(","));
      const headers = rows[0].map(h => h.trim());
      
      const tsIndex = headers.indexOf("Timestamp");
      const idIndex = headers.indexOf("ID number");

      if (tsIndex === -1 || idIndex === -1) {
        alert("CSV format error: Expected 'Timestamp' and 'ID number' columns");
        return;
      }

      const startDate = new Date("2025-09-08");
      const endDate = new Date("2025-09-28");

      // All valid dates excluding Sundays
      let totalDays = 0;
      let allDates = [];
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        if (d.getDay() !== 0) { // exclude Sunday
          totalDays++;
          allDates.push(new Date(d).toISOString().split("T")[0]);
        }
      }

      const studentDates = rows
        .slice(1)
        .filter(r => r[idIndex] && r[idIndex].trim() === studentId)
        .map(r => new Date(r[tsIndex]).toISOString().split("T")[0]);

      let present = 0;
      let tableRows = allDates.map(date => {
        if (studentDates.includes(date)) {
          present++;
          return `<tr><td>${date}</td><td class="present">Present</td></tr>`;
        } else {
          return `<tr><td>${date}</td><td class="absent">Absent</td></tr>`;
        }
      }).join("");

      let percentage = ((present / totalDays) * 100).toFixed(2);
      let percentageClass = percentage < 75 ? "low" : "";

      document.getElementById("result").innerHTML = `
        <h3>Attendance for ${studentId}</h3>
        <p>Total Days: ${totalDays}, Present: ${present}, Absent: ${totalDays - present}</p>
        <p>Attendance Percentage: <span class="${percentageClass}">${percentage}%</span></p>
        <table>
          <tr><th>Date</th><th>Status</th></tr>
          ${tableRows}
        </table>
      `;
    }
  </script>
</body>
</html>
