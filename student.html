<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Attendance Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex flex-col items-center p-6">

  <h1 class="text-2xl font-bold text-gray-800 mb-6">📌 Student Attendance Portal</h1>

  <!-- Search Box -->
  <div class="bg-white p-6 rounded-xl shadow-md max-w-lg w-full text-center mb-8">
    <form id="searchForm" class="space-y-4">
      <label for="studentId" class="block text-gray-700 font-medium">Enter your ID Number</label>
      <input 
        type="text" 
        id="studentId" 
        placeholder="e.g. R230557"
        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 focus:outline-none"
        required
      />
      <button 
        type="submit"
        class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition"
      >
        Search Attendance
      </button>
    </form>
  </div>

  <!-- Results -->
  <div id="results" class="bg-white p-6 rounded-xl shadow-md w-full max-w-4xl"></div>

  <script>
  async function fetchAttendance() {
    const response = await fetch(
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdMHIJ5IUW60rjdruE-lh96vAEcaJxbL55h-P2AKnbLwu45xgRMmU-fEoO3lwS8ypeIzZjpGmzHbvF/pub?output=csv"
    );
    const data = await response.text();
    const rows = data.trim().split("\n").map(r => r.split(","));

    // Normalize headers: lowercase, trim spaces, replace hidden spaces
    const headers = rows[0].map(h => h.trim().replace(/\u00A0/g, '').toLowerCase());

    // Build records
    const records = rows.slice(1).map(r => {
      let obj = {};
      r.forEach((cell, i) => {
        obj[headers[i]] = cell ? cell.trim().replace(/\u00A0/g, '') : "";
      });
      return obj;
    });

    return {records, headers};
  }

  document.getElementById("searchForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const idInput = document.getElementById("studentId").value.trim().toLowerCase();
    const {records, headers} = await fetchAttendance();

    const idCol = 'id number';
    const timestampCol = 'timestamp';
    const rollCol = 'roll number';

    // Unique class dates
    const allClasses = [...new Set(records.map(r => r[timestampCol]))];

    // Filter student records
    const studentRecords = records.filter(
      r => (r[idCol] || "").toLowerCase() === idInput
    );

    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "";

    if (studentRecords.length === 0) {
      console.log("All IDs found in sheet:", records.map(r => r[idCol]));
      resultsDiv.innerHTML =
        `<p class="text-red-600">❌ No records found for ID ${idInput}</p>
         <p class="text-gray-600">Check the console to see all IDs in the sheet.</p>`;
      return;
    }

    // Map student records by date
    const recordMap = {};
    studentRecords.forEach(r => {
      recordMap[r[timestampCol]] = r;
    });

    // Build table
    let table = `
      <table class="w-full border-collapse border border-gray-300 mt-4">
        <thead class="bg-gray-100">
          <tr>
            <th class="border border-gray-300 px-4 py-2">Date</th>
            <th class="border border-gray-300 px-4 py-2">Roll Number</th>
            <th class="border border-gray-300 px-4 py-2">ID Number</th>
            <th class="border border-gray-300 px-4 py-2">Status</th>
          </tr>
        </thead>
        <tbody>
    `;

    let attended = 0;
    allClasses.forEach(date => {
      if (recordMap[date]) {
        attended++;
        table += `
          <tr>
            <td class="border border-gray-300 px-4 py-2">${date}</td>
            <td class="border border-gray-300 px-4 py-2">${recordMap[date][rollCol]}</td>
            <td class="border border-gray-300 px-4 py-2">${recordMap[date][idCol]}</td>
            <td class="border border-green-600 px-4 py-2 font-bold">Present</td>
          </tr>
        `;
      } else {
        table += `
          <tr>
            <td class="border border-gray-300 px-4 py-2">${date}</td>
            <td class="border border-gray-300 px-4 py-2">-</td>
            <td class="border border-gray-300 px-4 py-2">${idInput}</td>
            <td class="border border-red-600 px-4 py-2 font-bold">Absent</td>
          </tr>
        `;
      }
    });

    table += "</tbody></table>";

    const percentage = ((attended / allClasses.length) * 100).toFixed(2);

    resultsDiv.innerHTML = `
      <p class="text-green-600 font-medium">✅ Found ${studentRecords.length} recorded classes for ID ${idInput}</p>
      <p class="text-blue-600 font-medium">📊 Attendance Percentage: ${percentage}%</p>
      ${table}
    `;
  });
  </script>
</body>
</html>
