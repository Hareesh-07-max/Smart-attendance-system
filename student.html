<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Attendance Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">

<div class="bg-white p-6 rounded-2xl shadow-md max-w-md mx-auto text-center">
  <h1 class="text-2xl font-bold text-gray-800 mb-4">ðŸŽ“ Student Attendance Portal</h1>

  <input id="studentId" type="text" placeholder="Enter your Student ID"
         class="px-4 py-2 border rounded-lg w-full mb-4">
  <button onclick="fetchAttendance()"
          class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
    ðŸ“Š Show Attendance
  </button>

  <div id="result" class="mt-4"></div>
</div>

<script>
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdMHIJ5IUW60rjdruE-lh96vAEcaJxbL55h-P2AKnbLwu45xgRMmU-fEoO3lwS8ypeIzZjpGmzHbvF/pub?output=csv";

// UPDATED DATE RANGE: Sep 15 to Sep 28
const startDate = new Date("2025-09-15");
const endDate = new Date("2025-09-28");

// Generate class dates excluding Sundays
function generateClassDates(start, end) {
  let dates = [];
  for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    if(d.getDay() !== 0) { // exclude Sundays
      dates.push(d.toISOString().split("T")[0]);
    }
  }
  return dates;
}

function fetchAttendance() {
  const studentIdInput = document.getElementById("studentId").value.trim();
  if(!studentIdInput) return alert("Enter a valid ID number!");

  Papa.parse(sheetUrl, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      const data = results.data;

      // Normalize column names and values
      const normalizedData = data.map(row => {
        let obj = {};
        for (let key in row) {
          obj[key.trim()] = row[key]?.trim();
        }
        return obj;
      });

      let studentDates = new Set();

      normalizedData.forEach(row => {
        const id = row["ID number"];
        const timestamp = row["Timestamp"];
        if(id === studentIdInput && timestamp) {
          let datePart = timestamp.split(" ")[0].trim();
          let [day, month, year] = datePart.split("/");
          if(day && month && year) {
            const formattedDate = `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
            studentDates.add(formattedDate);
          }
        }
      });

      const classDates = generateClassDates(startDate, endDate);
      let presentDays = 0;

      let table = `<table class="w-full border border-gray-300 text-sm">
        <tr class="bg-gray-200">
          <th class="border px-2 py-1">Date</th>
          <th class="border px-2 py-1">Status</th>
        </tr>`;

      classDates.forEach(date => {
        const status = studentDates.has(date) ? "Present" : "Absent";
        if(status === "Present") presentDays++;
        table += `<tr>
          <td class="border px-2 py-1">${date}</td>
          <td class="border px-2 py-1 ${status==="Present"?"text-green-600 font-bold":"text-red-600 font-bold"}">${status}</td>
        </tr>`;
      });

      const totalDays = classDates.length;
      const percentage = totalDays>0 ? ((presentDays/totalDays)*100).toFixed(2) : 0;
      const percentColor = percentage < 75 ? "text-red-600" : "text-green-600";

      table += `</table>
        <p class="mt-3 font-bold">Total Classes (excluding Sundays): ${totalDays}, Present: ${presentDays}, Absent: ${totalDays - presentDays}</p>
        <p class="font-bold ${percentColor}">Attendance Percentage: ${percentage}%</p>`;

      document.getElementById("result").innerHTML = table;
    }
  });
}
</script>

</body>
</html>
